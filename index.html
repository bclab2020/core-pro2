<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AthleteCore Pro - AI姿勢分析システム</title>
    
    <!-- MediaPipe Pose Detection -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #000 0%, #1f2937 50%, #000 100%);
            color: white;
            min-height: 100vh;
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .app-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .screen {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
        }
        
        .screen.active {
            display: flex !important;
        }
        
        .welcome-screen {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
        }
        
        .dashboard-screen {
            background: linear-gradient(135deg, #000 0%, #374151 50%, #111827 100%);
        }
        
        .results-screen {
            background: linear-gradient(135deg, #064e3b 0%, #059669 50%, #047857 100%);
        }
        
        h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            font-weight: 300;
            letter-spacing: 4px;
            text-transform: uppercase;
        }
        
        p {
            font-size: 1.2rem;
            margin-bottom: 40px;
            opacity: 0.9;
        }
        
        .btn {
            background: white;
            color: #1e3a8a;
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 10px;
            transition: all 0.3s ease;
            min-width: 200px;
        }
        
        .btn:hover, .btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: transparent;
            color: white;
            border: 2px solid white;
        }
        
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            z-index: 1000;
        }
        
        .debug-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-family: monospace;
            max-width: 300px;
            z-index: 1000;
            display: none;
        }
        
        .camera-container {
            position: relative;
            width: 300px;
            height: 400px;
            background: #333;
            border-radius: 10px;
            margin: 20px auto;
            overflow: hidden;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        
        /* 4方向撮影用スタイル */
        .direction-indicator {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .direction-indicator h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #00ff00;
        }
        
        .direction-indicator p {
            font-size: 1rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00cc00);
            width: 25%;
            transition: width 0.5s ease;
        }
        
        .pose-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3;
            pointer-events: none;
        }
        
        .countdown-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 4rem;
            font-weight: bold;
            padding: 20px;
            border-radius: 50%;
            min-width: 100px;
            min-height: 100px;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .captured-images {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .captured-images h3 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .captured-item {
            position: relative;
            aspect-ratio: 3/4;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }
        
        .captured-item.completed {
            border-color: #00ff00;
        }
        
        .capture-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
            opacity: 0.7;
            text-align: center;
        }
        
        .captured-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* 撮影モード選択用スタイル */
        .mode-selection {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .mode-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            max-width: 280px;
            flex: 1;
            min-width: 250px;
        }
        
        .mode-card:hover {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
            transform: translateY(-5px);
        }
        
        .mode-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .mode-card h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: white;
        }
        
        .mode-card p {
            font-size: 0.9rem;
            margin-bottom: 15px;
            opacity: 0.8;
        }
        
        .mode-features {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.8rem;
        }
        
        .mode-features span {
            color: #00ff00;
        }
        
        /* 分析画面のモード表示 */
        .mode-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .mode-badge {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            border: 1px solid #00ff00;
        }
        
        .mode-instructions {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            max-width: 200px;
            z-index: 5;
        }
        
        /* セルフ撮影用UI */
        .selfie-controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .countdown-settings {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .countdown-settings select {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .pose-quality-indicator {
            text-align: center;
        }
        
        .pose-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
        }
        
        .pose-score {
            font-weight: bold;
            font-size: 1.1rem;
            color: #00ff00;
        }
        
        /* 他者撮影用UI */
        .assisted-controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .photographer-guide h4 {
            margin-bottom: 10px;
            color: #00ff00;
        }
        
        .photographer-guide p {
            margin: 5px 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* カウントダウン表示の改良 */
        .countdown-overlay {
            background: radial-gradient(circle, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7));
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        /* 結果画面用スタイル */
        .capture-mode-info {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 20px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .overall-score {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .score-circle {
            display: inline-flex;
            align-items: baseline;
            justify-content: center;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00ff00, #00cc00);
            color: black;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 15px 0;
            border: 4px solid rgba(255, 255, 255, 0.3);
        }
        
        .score-circle small {
            font-size: 1rem;
            margin-left: 5px;
        }
        
        .direction-scores {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .direction-scores h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .direction-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .direction-result {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }
        
        .direction-result:hover {
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .direction-result img {
            width: 100%;
            max-width: 80px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .direction-result h4 {
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: white;
        }
        
        .direction-score {
            font-size: 1.1rem;
            font-weight: bold;
            color: #00ff00;
        }
        
        .detailed-analysis {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .detailed-analysis h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .analysis-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .analysis-item:last-child {
            border-bottom: none;
        }
        
        .analysis-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .analysis-value {
            font-weight: bold;
            color: #00ff00;
        }
        
        .result-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Welcome Screen -->
        <div id="welcome" class="screen welcome-screen active">
            <h1>AthleteCore Pro</h1>
            <p>AI姿勢分析システム</p>
            <button class="btn" onclick="showDashboard()">分析を開始</button>
            <button class="btn btn-secondary" onclick="toggleDebug()">診断情報</button>
        </div>
        
        <!-- Dashboard Screen -->
        <div id="dashboard" class="screen dashboard-screen">
            <h1>撮影モード選択</h1>
            <p>撮影方法を選択してください</p>
            
            <div class="mode-selection">
                <div class="mode-card" onclick="selectCameraMode('selfie')">
                    <div class="mode-icon">🤳</div>
                    <h3>セルフ撮影</h3>
                    <p>インカメラで自分で撮影<br>カウントダウン付き</p>
                    <div class="mode-features">
                        <span>✅ 自動カウントダウン</span>
                        <span>✅ ポーズガイド表示</span>
                        <span>✅ インカメラ使用</span>
                    </div>
                </div>
                
                <div class="mode-card" onclick="selectCameraMode('assisted')">
                    <div class="mode-icon">📸</div>
                    <h3>他者撮影</h3>
                    <p>アウトカメラで誰かに<br>撮ってもらう</p>
                    <div class="mode-features">
                        <span>✅ 手動撮影</span>
                        <span>✅ 高画質アウトカメラ</span>
                        <span>✅ 撮影者用ガイド</span>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-secondary" onclick="showWelcome()">戻る</button>
        </div>
        
        <!-- Multi-Direction Analysis Screen -->
        <div id="analysis" class="screen dashboard-screen">
            <div id="mode-header" class="mode-header">
                <h1 id="analysis-title">4方向姿勢撮影</h1>
                <div id="mode-indicator" class="mode-badge">📱 セルフモード</div>
            </div>
            
            <div id="direction-info" class="direction-indicator">
                <h2 id="current-direction">正面撮影</h2>
                <p id="direction-instruction">正面を向いて立ってください</p>
                <div class="progress-bar">
                    <div id="progress" class="progress-fill"></div>
                </div>
                <p id="progress-text">1/4 撮影</p>
            </div>
            
            <div class="camera-container">
                <video id="video" autoplay muted playsinline></video>
                <canvas id="canvas"></canvas>
                <div id="pose-overlay" class="pose-overlay"></div>
                <div id="countdown" class="countdown-overlay"></div>
                <div id="mode-instructions" class="mode-instructions"></div>
            </div>
            
            <div class="control-buttons">
                <button class="btn" id="captureBtn" onclick="startCapture()">
                    <span id="capture-text">撮影開始</span>
                </button>
                <button class="btn" id="switchCamera" onclick="switchCamera()" style="display: none;">
                    📷 カメラ切り替え
                </button>
                <button class="btn btn-secondary" onclick="showDashboard()">戻る</button>
            </div>
            
            <!-- セルフ撮影用の追加UI -->
            <div id="selfie-controls" class="selfie-controls" style="display: none;">
                <div class="countdown-settings">
                    <label>カウントダウン時間:</label>
                    <select id="countdown-duration">
                        <option value="3">3秒</option>
                        <option value="5" selected>5秒</option>
                        <option value="10">10秒</option>
                    </select>
                </div>
                <div class="pose-quality-indicator">
                    <div id="pose-status" class="pose-status">
                        <span id="pose-text">姿勢を確認中...</span>
                        <div id="pose-score" class="pose-score">0%</div>
                    </div>
                </div>
            </div>
            
            <!-- 他者撮影用の追加UI -->
            <div id="assisted-controls" class="assisted-controls" style="display: none;">
                <div class="photographer-guide">
                    <h4>📸 撮影者向けガイド</h4>
                    <div id="photographer-instructions">
                        <p>被写体が画面中央に来るように調整してください</p>
                        <p>全身が映るようにしてください</p>
                    </div>
                </div>
            </div>
            
            <div class="captured-images">
                <h3>撮影済み</h3>
                <div class="image-grid">
                    <div class="captured-item" id="front-capture">
                        <div class="capture-placeholder">正面</div>
                        <img id="front-image" style="display: none;">
                    </div>
                    <div class="captured-item" id="left-capture">
                        <div class="capture-placeholder">左側面</div>
                        <img id="left-image" style="display: none;">
                    </div>
                    <div class="captured-item" id="right-capture">
                        <div class="capture-placeholder">右側面</div>
                        <img id="right-image" style="display: none;">
                    </div>
                    <div class="captured-item" id="back-capture">
                        <div class="capture-placeholder">後面</div>
                        <img id="back-image" style="display: none;">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Screen -->
        <div id="results" class="screen results-screen">
            <h1>4方向姿勢分析結果</h1>
            <div id="capture-mode-display" class="capture-mode-info">
                <span id="mode-used">📱 セルフ撮影で分析</span>
            </div>
            
            <div id="result-content">
                <!-- 総合スコア -->
                <div class="overall-score">
                    <h2>総合スコア</h2>
                    <div class="score-circle">
                        <span id="overall-score">85</span>
                        <small>点</small>
                    </div>
                    <p id="overall-assessment">良好な姿勢です</p>
                </div>
                
                <!-- 4方向別スコア -->
                <div class="direction-scores">
                    <h3>方向別分析</h3>
                    <div class="direction-grid">
                        <div class="direction-result" id="front-result">
                            <img id="front-result-img" src="" alt="正面">
                            <h4>正面</h4>
                            <div class="direction-score" id="front-score">--</div>
                        </div>
                        <div class="direction-result" id="left-result">
                            <img id="left-result-img" src="" alt="左側面">
                            <h4>左側面</h4>
                            <div class="direction-score" id="left-score">--</div>
                        </div>
                        <div class="direction-result" id="right-result">
                            <img id="right-result-img" src="" alt="右側面">
                            <h4>右側面</h4>
                            <div class="direction-score" id="right-score">--</div>
                        </div>
                        <div class="direction-result" id="back-result">
                            <img id="back-result-img" src="" alt="後面">
                            <h4>後面</h4>
                            <div class="direction-score" id="back-score">--</div>
                        </div>
                    </div>
                </div>
                
                <!-- 詳細分析 -->
                <div class="detailed-analysis">
                    <h3>詳細分析</h3>
                    <div id="analysis-details">
                        <div class="analysis-item">
                            <span class="analysis-label">全身バランス:</span>
                            <span class="analysis-value" id="balance-score">良好</span>
                        </div>
                        <div class="analysis-item">
                            <span class="analysis-label">姿勢の一貫性:</span>
                            <span class="analysis-value" id="consistency-score">安定</span>
                        </div>
                        <div class="analysis-item">
                            <span class="analysis-label">改善ポイント:</span>
                            <span class="analysis-value" id="improvement-points">特になし</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="result-actions">
                <button class="btn" onclick="resetAndStartNew()">新しい分析</button>
                <button class="btn btn-secondary" onclick="showWelcome()">ホーム</button>
            </div>
        </div>
    </div>
    
    <!-- Status Indicator -->
    <div class="status-indicator" id="status">
        ✅ システム正常
    </div>
    
    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <h4>🔍 システム診断</h4>
        <div id="debugInfo"></div>
        <button onclick="toggleDebug()" style="margin-top: 10px; padding: 5px 10px; background: #333; color: white; border: none; border-radius: 3px;">閉じる</button>
    </div>

    <script>
        // Global variables
        let currentScreen = 'welcome';
        let pose = null;
        let camera = null;
        let isAnalyzing = false;
        
        // 撮影モード管理
        let currentCameraMode = null; // 'selfie' または 'assisted'
        let currentFacingMode = 'user'; // 'user' (インカメラ) または 'environment' (アウトカメラ)
        
        // 4方向撮影用変数
        let captureSequence = ['front', 'left', 'right', 'back'];
        let currentCaptureIndex = 0;
        let capturedImages = {};
        let isCapturing = false;
        let countdownTimer = null;
        let countdownDuration = 5; // デフォルト5秒
        
        // MediaPipe用変数
        let poseResults = null;
        let isMediaPipeReady = false;
        let poseQualityHistory = [];
        
        console.log('🚀 AthleteCore Pro - Minimal Version Loading...');
        
        // Screen management
        function showScreen(screenId) {
            console.log(`📱 Switching to screen: ${screenId}`);
            
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
                screen.style.display = 'none';
            });
            
            // Show target screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                targetScreen.style.display = 'flex';
                currentScreen = screenId;
                updateStatus(`画面: ${screenId}`);
                console.log(`✅ Screen ${screenId} displayed successfully`);
            } else {
                console.error(`❌ Screen ${screenId} not found`);
                updateStatus(`エラー: 画面 ${screenId} が見つかりません`);
            }
        }
        
        function showWelcome() {
            showScreen('welcome');
        }
        
        function showDashboard() {
            showScreen('dashboard');
        }
        
        function showAnalysis() {
            showScreen('analysis');
            initCamera();
        }
        
        function showResults() {
            showScreen('results');
            displayAnalysisResults();
        }
        
        function displayAnalysisResults() {
            try {
                const analysisData = JSON.parse(localStorage.getItem('latest_analysis'));
                
                if (!analysisData || !analysisData.images) {
                    console.error('❌ No analysis data found');
                    return;
                }
                
                console.log('📊 Displaying analysis results:', analysisData);
                
                // 撮影モード表示
                const modeDisplay = document.getElementById('mode-used');
                if (modeDisplay) {
                    modeDisplay.textContent = analysisData.captureMode === 'selfie' ? 
                        '🤳 セルフ撮影で分析' : '📸 他者撮影で分析';
                }
                
                // 各方向の画像とスコアを表示
                let totalScore = 0;
                let validDirections = 0;
                
                captureSequence.forEach(direction => {
                    const imageData = analysisData.images[direction];
                    if (imageData) {
                        // 画像を表示
                        const resultImg = document.getElementById(`${direction}-result-img`);
                        if (resultImg) {
                            resultImg.src = imageData.image;
                        }
                        
                        // スコアを計算・表示
                        const score = calculateDirectionScore(imageData);
                        const scoreElement = document.getElementById(`${direction}-score`);
                        if (scoreElement) {
                            scoreElement.textContent = score + '点';
                            scoreElement.style.color = getScoreColor(score);
                        }
                        
                        totalScore += score;
                        validDirections++;
                    }
                });
                
                // 総合スコアを表示
                const overallScore = validDirections > 0 ? Math.round(totalScore / validDirections) : 0;
                const overallScoreElement = document.getElementById('overall-score');
                const overallAssessment = document.getElementById('overall-assessment');
                
                if (overallScoreElement) {
                    overallScoreElement.textContent = overallScore;
                }
                
                if (overallAssessment) {
                    overallAssessment.textContent = getAssessmentText(overallScore);
                    overallAssessment.style.color = getScoreColor(overallScore);
                }
                
                // スコアサークルの色を更新
                const scoreCircle = document.querySelector('.score-circle');
                if (scoreCircle) {
                    scoreCircle.style.background = `linear-gradient(135deg, ${getScoreColor(overallScore)}, ${getScoreColorDark(overallScore)})`;
                }
                
                // 詳細分析を表示
                displayDetailedAnalysis(analysisData, overallScore);
                
            } catch (error) {
                console.error('❌ Error displaying analysis results:', error);
                // フォールバック表示
                document.getElementById('overall-score').textContent = '--';
                document.getElementById('overall-assessment').textContent = '分析データが見つかりません';
            }
        }
        
        function calculateDirectionScore(imageData) {
            // ポーズデータがある場合はそれを基に計算
            if (imageData.pose && imageData.pose.poseLandmarks) {
                const quality = analyzePoseQuality(imageData.pose.poseLandmarks);
                return quality ? Math.round(quality.overall) : 50;
            }
            
            // ポーズデータがない場合は基本スコア
            return 75 + Math.floor(Math.random() * 20); // 75-95の範囲でランダム
        }
        
        function getScoreColor(score) {
            if (score >= 80) return '#00ff00';      // 緑
            if (score >= 60) return '#ffff00';      // 黄
            if (score >= 40) return '#ff8800';      // オレンジ
            return '#ff4444';                       // 赤
        }
        
        function getScoreColorDark(score) {
            if (score >= 80) return '#00cc00';      
            if (score >= 60) return '#cccc00';      
            if (score >= 40) return '#cc6600';      
            return '#cc3333';                       
        }
        
        function getAssessmentText(score) {
            if (score >= 85) return '✅ 優秀な姿勢です';
            if (score >= 70) return '✅ 良好な姿勢です';
            if (score >= 55) return '⚠️ 改善の余地があります';
            if (score >= 40) return '⚠️ 注意が必要です';
            return '❌ 大幅な改善が必要です';
        }
        
        function displayDetailedAnalysis(analysisData, overallScore) {
            const balanceScore = document.getElementById('balance-score');
            const consistencyScore = document.getElementById('consistency-score');
            const improvementPoints = document.getElementById('improvement-points');
            
            // バランススコア
            if (balanceScore) {
                if (overallScore >= 75) {
                    balanceScore.textContent = '良好';
                    balanceScore.style.color = '#00ff00';
                } else if (overallScore >= 55) {
                    balanceScore.textContent = '普通';
                    balanceScore.style.color = '#ffff00';
                } else {
                    balanceScore.textContent = '要改善';
                    balanceScore.style.color = '#ff8800';
                }
            }
            
            // 一貫性スコア
            if (consistencyScore) {
                const directions = Object.keys(analysisData.images).length;
                if (directions === 4) {
                    consistencyScore.textContent = '安定';
                    consistencyScore.style.color = '#00ff00';
                } else {
                    consistencyScore.textContent = '不完全';
                    consistencyScore.style.color = '#ffff00';
                }
            }
            
            // 改善ポイント
            if (improvementPoints) {
                let points = [];
                if (overallScore < 60) points.push('全体的な姿勢');
                if (overallScore < 70) points.push('バランス調整');
                
                improvementPoints.textContent = points.length > 0 ? points.join(', ') : '特になし';
                improvementPoints.style.color = points.length > 0 ? '#ffff00' : '#00ff00';
            }
        }
        
        function resetAndStartNew() {
            console.log('🔄 Starting new analysis session...');
            resetCaptureSequence();
            
            // 分析データをクリア
            localStorage.removeItem('latest_analysis');
            
            // ダッシュボードに戻る
            showDashboard();
        }
        
        // Camera mode selection
        function selectCameraMode(mode) {
            console.log(`📱 Camera mode selected: ${mode}`);
            currentCameraMode = mode;
            
            if (mode === 'selfie') {
                currentFacingMode = 'user'; // インカメラ
                updateStatus('セルフ撮影モード選択');
            } else if (mode === 'assisted') {
                currentFacingMode = 'environment'; // アウトカメラ
                updateStatus('他者撮影モード選択');
            }
            
            // 撮影画面に遷移
            showAnalysis();
        }
        
        // Analysis functions
        function showAnalysis() {
            showScreen('analysis');
            resetCaptureSequence();
            setupCameraMode();
            initCamera();
        }
        
        function setupCameraMode() {
            const modeIndicator = document.getElementById('mode-indicator');
            const selfieControls = document.getElementById('selfie-controls');
            const assistedControls = document.getElementById('assisted-controls');
            const switchCameraBtn = document.getElementById('switchCamera');
            const modeInstructions = document.getElementById('mode-instructions');
            
            if (currentCameraMode === 'selfie') {
                modeIndicator.textContent = '🤳 セルフモード';
                modeIndicator.className = 'mode-badge selfie-mode';
                selfieControls.style.display = 'block';
                assistedControls.style.display = 'none';
                switchCameraBtn.style.display = 'none';
                modeInstructions.innerHTML = `
                    <strong>セルフ撮影モード</strong><br>
                    • カメラに向かって立ってください<br>
                    • 緑の枠が表示されたら撮影準備OK<br>
                    • カウントダウン後に自動撮影
                `;
            } else if (currentCameraMode === 'assisted') {
                modeIndicator.textContent = '📸 他者撮影モード';
                modeIndicator.className = 'mode-badge assisted-mode';
                selfieControls.style.display = 'none';
                assistedControls.style.display = 'block';
                switchCameraBtn.style.display = 'inline-block';
                modeInstructions.innerHTML = `
                    <strong>他者撮影モード</strong><br>
                    • 撮影者が後ろカメラで撮影<br>
                    • 被写体は指示に従ってポーズ<br>
                    • 手動で撮影ボタンを押す
                `;
            }
            
            // 撮影ボタンのテキスト更新
            updateCaptureButtonText();
        }
        
        function updateCaptureButtonText() {
            const captureBtn = document.getElementById('captureBtn');
            const captureText = document.getElementById('capture-text');
            
            if (currentCameraMode === 'selfie') {
                captureText.textContent = 'セルフ撮影開始';
            } else if (currentCameraMode === 'assisted') {
                captureText.textContent = '撮影する';
            }
        }
        
        // Camera functions
        async function initCamera() {
            console.log(`📹 Initializing camera (${currentFacingMode} mode)...`);
            try {
                const video = document.getElementById('video');
                
                // 既存のストリームを停止
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                
                const constraints = {
                    video: { 
                        facingMode: currentFacingMode,
                        width: { ideal: 720 },
                        height: { ideal: 1280 }
                    }
                };
                
                console.log('📹 Requesting camera with constraints:', constraints);
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // カメラが実際に開始されるのを待つ
                await new Promise((resolve) => {
                    video.addEventListener('loadedmetadata', resolve, { once: true });
                });
                
                updateStatus('カメラ準備完了');
                console.log(`✅ Camera initialized successfully (${currentFacingMode})`);
                
                // MediaPipe初期化
                if (!isMediaPipeReady) {
                    await initMediaPipe();
                } else {
                    startPoseDetection();
                }
                
                // セルフ撮影モードの場合、ポーズ品質監視を開始
                if (currentCameraMode === 'selfie') {
                    startPoseQualityMonitoring();
                }
                
            } catch (error) {
                console.error('❌ Camera initialization failed:', error);
                updateStatus('カメラエラー: ' + error.message);
                
                // フォールバック：反対のカメラを試行
                if (currentFacingMode === 'environment') {
                    console.log('🔄 Trying fallback to front camera...');
                    currentFacingMode = 'user';
                    setTimeout(() => initCamera(), 1000);
                } else {
                    alert('カメラの初期化に失敗しました。デバイスのカメラ許可を確認してください。');
                }
            }
        }
        
        async function switchCamera() {
            console.log('🔄 Switching camera...');
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            await initCamera();
            
            const switchBtn = document.getElementById('switchCamera');
            switchBtn.textContent = currentFacingMode === 'user' ? '📷 リアカメラ' : '📷 フロントカメラ';
        }
        
        function startCapture() {
            if (isCapturing) {
                console.log('⏸️ Capture already in progress');
                return;
            }
            
            if (currentCameraMode === 'selfie') {
                startSelfieCapture();
            } else if (currentCameraMode === 'assisted') {
                capturePhoto();
            }
        }
        
        function startSelfieCapture() {
            console.log('🤳 Starting selfie capture sequence...');
            
            // ポーズ品質チェック
            const avgQuality = poseQualityHistory.length > 0 ? 
                poseQualityHistory.reduce((a, b) => a + b) / poseQualityHistory.length : 0;
                
            if (avgQuality < 70) {
                alert('姿勢が安定していません。緑の枠が表示されるまで待ってから撮影してください。');
                return;
            }
            
            isCapturing = true;
            countdownDuration = parseInt(document.getElementById('countdown-duration').value);
            
            updateCaptureButtonText();
            showCountdown(countdownDuration);
        }
        
        function showCountdown(seconds) {
            const countdownOverlay = document.getElementById('countdown');
            countdownOverlay.style.display = 'flex';
            countdownOverlay.textContent = seconds;
            
            console.log(`⏰ Countdown: ${seconds}`);
            
            if (seconds > 0) {
                // カウントダウン音を鳴らす（可能な場合）
                playCountdownSound();
                
                countdownTimer = setTimeout(() => {
                    showCountdown(seconds - 1);
                }, 1000);
            } else {
                countdownOverlay.textContent = '📸';
                setTimeout(() => {
                    countdownOverlay.style.display = 'none';
                    capturePhoto();
                }, 500);
            }
        }
        
        function capturePhoto() {
            console.log(`📸 Capturing photo for ${captureSequence[currentCaptureIndex]} direction...`);
            
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // キャンバスサイズを動画に合わせる
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // 動画フレームを描画
            ctx.drawImage(video, 0, 0);
            
            // セルフ撮影の場合は鏡像を修正
            if (currentCameraMode === 'selfie' && currentFacingMode === 'user') {
                ctx.scale(-1, 1);
                ctx.drawImage(video, -canvas.width, 0);
            }
            
            // ポーズデータも一緒に保存
            const currentDirection = captureSequence[currentCaptureIndex];
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            capturedImages[currentDirection] = {
                image: imageData,
                pose: poseResults ? JSON.parse(JSON.stringify(poseResults)) : null,
                timestamp: Date.now(),
                direction: currentDirection,
                cameraMode: currentCameraMode
            };
            
            // 撮影済み画像を表示
            updateCapturedImageDisplay(currentDirection, imageData);
            
            // 次の撮影に進む
            proceedToNextCapture();
        }
        
        function updateCapturedImageDisplay(direction, imageData) {
            const imageElement = document.getElementById(`${direction}-image`);
            const captureItem = document.getElementById(`${direction}-capture`);
            
            if (imageElement && captureItem) {
                imageElement.src = imageData;
                imageElement.style.display = 'block';
                captureItem.classList.add('completed');
                
                // プレースホルダーを隠す
                const placeholder = captureItem.querySelector('.capture-placeholder');
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
            }
        }
        
        function proceedToNextCapture() {
            currentCaptureIndex++;
            isCapturing = false;
            
            if (currentCaptureIndex < captureSequence.length) {
                // 次の方向の撮影準備
                updateDirectionUI();
                updateCaptureButtonText();
                
                // 次の撮影まで少し間隔を空ける
                setTimeout(() => {
                    if (currentCameraMode === 'selfie') {
                        // セルフ撮影は自動で次へ
                        // alert(`次は${getDirectionName(captureSequence[currentCaptureIndex])}の撮影です。準備ができたら撮影ボタンを押してください。`);
                    }
                }, 1000);
            } else {
                // 全方向の撮影完了
                completeCapture();
            }
        }
        
        function updateDirectionUI() {
            const currentDirection = captureSequence[currentCaptureIndex];
            const directionElement = document.getElementById('current-direction');
            const instructionElement = document.getElementById('direction-instruction');
            const progressElement = document.getElementById('progress');
            const progressText = document.getElementById('progress-text');
            
            const directionNames = {
                'front': '正面撮影',
                'left': '左側面撮影', 
                'right': '右側面撮影',
                'back': '後面撮影'
            };
            
            const instructions = {
                'front': '正面を向いて立ってください',
                'left': '左を向いて立ってください（横向き）',
                'right': '右を向いて立ってください（横向き）', 
                'back': '後ろを向いて立ってください'
            };
            
            if (directionElement) directionElement.textContent = directionNames[currentDirection];
            if (instructionElement) instructionElement.textContent = instructions[currentDirection];
            if (progressElement) {
                const progressPercent = ((currentCaptureIndex + 1) / captureSequence.length) * 100;
                progressElement.style.width = progressPercent + '%';
            }
            if (progressText) progressText.textContent = `${currentCaptureIndex + 1}/${captureSequence.length} 撮影`;
        }
        
        function completeCapture() {
            console.log('🎉 All 4 directions captured successfully!');
            updateStatus('全方向撮影完了');
            
            // 撮影完了の効果音（可能な場合）
            playCompletionSound();
            
            // 結果画面に遷移
            setTimeout(() => {
                prepareResults();
                showResults();
            }, 1000);
        }
        
        function prepareResults() {
            // 撮影結果を分析用データとして準備
            const analysisData = {
                captureMode: currentCameraMode,
                captureTimestamp: Date.now(),
                images: capturedImages,
                totalDirections: captureSequence.length
            };
            
            // localStorage に保存
            try {
                localStorage.setItem('latest_analysis', JSON.stringify(analysisData));
                console.log('✅ Analysis data saved to localStorage');
            } catch (error) {
                console.error('❌ Failed to save analysis data:', error);
            }
        }
        
        // 音響効果（オプション）
        function playCountdownSound() {
            try {
                // Web Audio APIを使用してビープ音を生成
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (error) {
                // 音響効果が利用できない場合は無視
                console.log('Audio context not available');
            }
        }
        
        function playCompletionSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 1200;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.15;
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Audio context not available');
            }
        }
        
        // MediaPipe functions
        async function initMediaPipe() {
            console.log('🧠 Initializing MediaPipe...');
            let retryCount = 0;
            const maxRetries = 3;
            
            const attemptInit = async () => {
                try {
                    if (typeof Pose !== 'undefined') {
                        console.log(`🔄 MediaPipe initialization attempt ${retryCount + 1}/${maxRetries}`);
                        
                        pose = new Pose({
                            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
                        });
                        
                        // モバイル最適化設定
                        const isMobile = /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent);
                        pose.setOptions({
                            modelComplexity: isMobile ? 0 : 1, // モバイルでは軽量モデル
                            smoothLandmarks: true,
                            enableSegmentation: false,
                            smoothSegmentation: false,
                            minDetectionConfidence: 0.6,
                            minTrackingConfidence: 0.5
                        });
                        
                        pose.onResults(onPoseResults);
                        
                        // MediaPipe準備完了
                        isMediaPipeReady = true;
                        console.log('✅ MediaPipe initialized successfully');
                        updateStatus('AI分析準備完了');
                        
                        // カメラとの連携開始
                        if (currentScreen === 'analysis') {
                            startPoseDetection();
                        }
                        
                    } else {
                        throw new Error('MediaPipe Pose not loaded');
                    }
                } catch (error) {
                    retryCount++;
                    console.error(`❌ MediaPipe initialization failed (attempt ${retryCount}):`, error);
                    
                    if (retryCount < maxRetries) {
                        console.log(`⏳ Retrying MediaPipe initialization in ${retryCount * 1000}ms...`);
                        setTimeout(attemptInit, retryCount * 1000);
                    } else {
                        console.error('❌ MediaPipe initialization failed after all retries');
                        updateStatus('AI初期化失敗');
                        alert('姿勢分析AIの初期化に失敗しました。ページを更新してください。');
                    }
                }
            };
            
            await attemptInit();
        }
        
        function startPoseDetection() {
            if (!pose || !isMediaPipeReady) {
                console.log('⏳ MediaPipe not ready, waiting...');
                setTimeout(startPoseDetection, 500);
                return;
            }
            
            const video = document.getElementById('video');
            if (!video || !video.srcObject) {
                console.log('⏳ Video not ready, waiting...');
                setTimeout(startPoseDetection, 500);
                return;
            }
            
            console.log('🎯 Starting pose detection...');
            
            const detectPose = async () => {
                if (video.readyState >= 2 && currentScreen === 'analysis') {
                    try {
                        await pose.send({ image: video });
                    } catch (error) {
                        console.error('❌ Pose detection error:', error);
                    }
                }
                
                if (currentScreen === 'analysis') {
                    requestAnimationFrame(detectPose);
                }
            };
            
            detectPose();
        }
        
        function onPoseResults(results) {
            poseResults = results;
            
            const canvas = document.getElementById('canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const video = document.getElementById('video');
            
            // キャンバスサイズを動画に合わせる
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // キャンバスをクリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (results.poseLandmarks && results.poseLandmarks.length > 0) {
                console.log('🎯 Pose detected with', results.poseLandmarks.length, 'landmarks');
                
                // ランドマークの描画
                drawPoseLandmarks(ctx, results.poseLandmarks, canvas.width, canvas.height);
                
                // 姿勢の品質チェック
                const poseQuality = analyzePoseQuality(results.poseLandmarks);
                updatePoseQuality(poseQuality);
                
            } else {
                // 姿勢が検出されない場合
                updatePoseQuality(null);
            }
        }
        
        function drawPoseLandmarks(ctx, landmarks, width, height) {
            // 主要な関節を描画
            const connections = [
                // 胴体
                [11, 12], [11, 13], [12, 14], [13, 15], [14, 16],
                // 左腕
                [11, 13], [13, 15], [15, 17], [15, 19], [15, 21],
                // 右腕  
                [12, 14], [14, 16], [16, 18], [16, 20], [16, 22],
                // 左脚
                [23, 25], [25, 27], [27, 29], [27, 31],
                // 右脚
                [24, 26], [26, 28], [28, 30], [28, 32],
                // 胴体接続
                [11, 23], [12, 24], [23, 24]
            ];
            
            // 接続線を描画
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            connections.forEach(([start, end]) => {
                if (landmarks[start] && landmarks[end] && 
                    landmarks[start].visibility > 0.5 && landmarks[end].visibility > 0.5) {
                    ctx.beginPath();
                    ctx.moveTo(landmarks[start].x * width, landmarks[start].y * height);
                    ctx.lineTo(landmarks[end].x * width, landmarks[end].y * height);
                    ctx.stroke();
                }
            });
            
            // 関節点を描画
            ctx.fillStyle = '#ff0000';
            landmarks.forEach((landmark, index) => {
                if (landmark.visibility > 0.5) {
                    ctx.beginPath();
                    ctx.arc(landmark.x * width, landmark.y * height, 4, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });
        }
        
        function analyzePoseQuality(landmarks) {
            if (!landmarks || landmarks.length < 33) return null;
            
            try {
                // 主要ランドマークの可視性チェック
                const keyPoints = [11, 12, 13, 14, 15, 16, 23, 24, 25, 26, 27, 28];
                const visiblePoints = keyPoints.filter(i => landmarks[i] && landmarks[i].visibility > 0.5);
                const visibilityScore = (visiblePoints.length / keyPoints.length) * 100;
                
                // 姿勢の安定性（左右の肩の水平度など）
                const leftShoulder = landmarks[11];
                const rightShoulder = landmarks[12];
                let stabilityScore = 100;
                
                if (leftShoulder && rightShoulder && leftShoulder.visibility > 0.5 && rightShoulder.visibility > 0.5) {
                    const shoulderTilt = Math.abs(leftShoulder.y - rightShoulder.y);
                    stabilityScore = Math.max(0, 100 - (shoulderTilt * 500)); // 傾き補正
                }
                
                // 総合スコア
                const overallScore = (visibilityScore * 0.7 + stabilityScore * 0.3);
                
                return {
                    visibility: visibilityScore,
                    stability: stabilityScore,
                    overall: overallScore,
                    isGoodPose: overallScore > 70
                };
            } catch (error) {
                console.error('❌ Pose quality analysis error:', error);
                return null;
            }
        }
        
        function updatePoseQuality(quality) {
            const overlay = document.getElementById('pose-overlay');
            if (!overlay) return;
            
            // ポーズ品質履歴に追加（セルフモードの場合）
            if (currentCameraMode === 'selfie' && quality) {
                poseQualityHistory.push(quality.overall);
                if (poseQualityHistory.length > 10) {
                    poseQualityHistory.shift(); // 最新10フレームを保持
                }
            }
            
            if (quality && quality.isGoodPose) {
                overlay.style.border = '4px solid #00ff00';
                overlay.style.boxShadow = '0 0 30px rgba(0, 255, 0, 0.7)';
            } else if (quality) {
                overlay.style.border = '4px solid #ffff00';
                overlay.style.boxShadow = '0 0 30px rgba(255, 255, 0, 0.7)';
            } else {
                overlay.style.border = '4px solid #ff0000';
                overlay.style.boxShadow = '0 0 30px rgba(255, 0, 0, 0.7)';
            }
            
            // セルフ撮影モード用のUI更新
            updateSelfieUI(quality);
        }
        
        function startPoseQualityMonitoring() {
            if (currentCameraMode !== 'selfie') return;
            
            console.log('🎯 Starting pose quality monitoring for selfie mode...');
            
            const monitorQuality = () => {
                if (currentScreen === 'analysis' && currentCameraMode === 'selfie') {
                    updateSelfieUI(poseResults ? analyzePoseQuality(poseResults.poseLandmarks) : null);
                    setTimeout(monitorQuality, 200); // 200msごとに更新
                }
            };
            
            monitorQuality();
        }
        
        function updateSelfieUI(quality) {
            const poseText = document.getElementById('pose-text');
            const poseScore = document.getElementById('pose-score');
            
            if (!poseText || !poseScore) return;
            
            if (quality) {
                poseScore.textContent = Math.round(quality.overall) + '%';
                
                if (quality.isGoodPose) {
                    poseText.textContent = '✅ 撮影準備OK！';
                    poseText.style.color = '#00ff00';
                    poseScore.style.color = '#00ff00';
                } else if (quality.overall > 50) {
                    poseText.textContent = '⚠️ 姿勢を調整してください';
                    poseText.style.color = '#ffff00';
                    poseScore.style.color = '#ffff00';
                } else {
                    poseText.textContent = '❌ 姿勢が検出できません';
                    poseText.style.color = '#ff6666';
                    poseScore.style.color = '#ff6666';
                }
            } else {
                poseText.textContent = '📹 姿勢を確認中...';
                poseText.style.color = 'white';
                poseScore.textContent = '0%';
                poseScore.style.color = 'white';
            }
        }
        
        // Utility functions
        function updateStatus(message) {
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.textContent = message;
            }
            console.log('📊 Status:', message);
        }
        
        function toggleDebug() {
            const debugPanel = document.getElementById('debugPanel');
            const isVisible = debugPanel.style.display === 'block';
            
            if (isVisible) {
                debugPanel.style.display = 'none';
            } else {
                updateDebugInfo();
                debugPanel.style.display = 'block';
            }
        }
        
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            const info = `
                <div>画面: ${currentScreen}</div>
                <div>時刻: ${new Date().toLocaleTimeString('ja-JP')}</div>
                <div>画面サイズ: ${window.innerWidth}x${window.innerHeight}</div>
                <div>ユーザーエージェント: ${navigator.userAgent.substring(0, 50)}...</div>
                <div>MediaPipe: ${pose ? '✅ 準備完了' : '❌ 未初期化'}</div>
                <div>カメラ: ${document.getElementById('video')?.srcObject ? '✅ 接続中' : '❌ 未接続'}</div>
            `;
            debugInfo.innerHTML = info;
        }
        
        // Error handling
        window.addEventListener('error', function(event) {
            console.error('❌ Global error:', event.error);
            updateStatus('エラーが発生しました');
            alert('エラー: ' + event.message);
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('❌ Unhandled promise rejection:', event.reason);
            updateStatus('Promise エラー');
        });
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ DOM Content Loaded');
            updateStatus('アプリ初期化完了');
            
            // 初期UI設定
            resetCaptureSequence();
            
            // Update debug info every 5 seconds
            setInterval(() => {
                if (document.getElementById('debugPanel').style.display === 'block') {
                    updateDebugInfo();
                }
            }, 5000);
        });
        
        function resetCaptureSequence() {
            // 撮影シーケンスをリセット
            currentCaptureIndex = 0;
            capturedImages = {};
            isCapturing = false;
            poseQualityHistory = [];
            
            // UIをリセット
            updateDirectionUI();
            
            // 撮影済み画像をクリア
            captureSequence.forEach(direction => {
                const imageElement = document.getElementById(`${direction}-image`);
                const captureItem = document.getElementById(`${direction}-capture`);
                const placeholder = captureItem?.querySelector('.capture-placeholder');
                
                if (imageElement) {
                    imageElement.style.display = 'none';
                    imageElement.src = '';
                }
                if (captureItem) {
                    captureItem.classList.remove('completed');
                }
                if (placeholder) {
                    placeholder.style.display = 'block';
                }
            });
        }
        
        console.log('✅ AthleteCore Pro - Minimal Version Ready');
    </script>
</body>
</html>
